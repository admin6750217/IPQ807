name: Full-Auto-CI

on:
  schedule:
    - cron: "0 14 * * *"   # 每天北京时间 22 点触发
  workflow_dispatch:
    inputs:
      PACKAGE:
        description: '手动调整插件包，多个请用 \\n 隔开'
        required: false
        type: string
      TEST:
        description: '仅输出配置文件，不编译固件'
        default: false
        required: false
        type: boolean

permissions:
  contents: write
  actions: write

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # ===========================
  # 1️⃣ 自动清理旧 Release / Workflow
  # ===========================
  auto_clean:
    name: Auto-Clean
    runs-on: ubuntu-latest
    if: github.repository_owner == 'admin6750217'
    steps:
      - name: Delete old Releases / Workflows
        uses: ophub/delete-releases-workflows@main
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}
          delete_releases: true
          releases_keep_latest: 1
          delete_workflows: true
          workflows_keep_day: 7

  # ===========================
  # 2️⃣ 编译 ImmortalWrt
  # ===========================
  build_fw:
    name: Build ImmortalWrt Firmware
    runs-on: ubuntu-latest
    needs: auto_clean

    steps:
      # 1. Checkout 自己仓库（用于读取 .config 等）
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. Clone ImmortalWrt 源码
      - name: Clone ImmortalWrt Source
        run: |
          git clone --depth 1 https://github.com/VIKINGYFY/immortalwrt.git immortalwrt

      # 3. 进入源码目录
      - name: Prepare Build
        working-directory: immortalwrt
        run: |
          cp ../.config .config || true
          cp ../feeds.conf.default feeds.conf.default || true

      # 4. Update & Install Feeds
      - name: Update & Install Feeds
        working-directory: immortalwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 5. Run defconfig (根据 .config 编译)
      - name: Apply Config
        working-directory: immortalwrt
        run: |
          yes "" | make defconfig

      # 6. Build Firmware
      - name: Build Firmware
        working-directory: immortalwrt
        run: |
          make -j$(nproc) || true

      # 7. Upload Artifacts (固件输出)
      - name: Upload Firmware Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: immortalwrt-firmware
          path: |
            immortalwrt/bin/
            immortalwrt/build_dir/

  # ===========================
  # 3️⃣ 发布 Release
  # ===========================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build_fw

    steps:
      - name: Download Built Artifacts
        uses: actions/download-artifact@v3
        with:
          name: immortalwrt-firmware
          path: fw_out

      - name: Create Release
        id: release
        uses: ncipollo/release-action@v1
        with:
          tag: "immortalwrt-build-${{ github.run_number }}"
          name: "immortalwrt build #${{ github.run_number }}"
          body: "自动编译的 ImmortalWrt 固件"
          draft: false
          prerelease: false

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            fw_out/**/*
